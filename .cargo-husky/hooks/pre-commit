#!/bin/sh
# Pre-commit hook to format and fix Rust code
# This hook runs cargo fmt and cargo fix before committing
# If api/openapi.json has changed, it also updates all OpenAPI clients

REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
cd "$REPO_ROOT" || exit 1

echo "Running pre-commit hook..."

# Check if api/openapi.json is in the staged changes (added, modified, or renamed)
SHOULD_UPDATE=false
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null)

# Check if openapi.json is in the staged files
if echo "$STAGED_FILES" | grep -q "openapi.json"; then
    SHOULD_UPDATE=true
fi

# Also check if the file differs from HEAD (handles cases where it's modified)
if [ "$SHOULD_UPDATE" = false ]; then
    if git diff --name-only HEAD -- "api/openapi.json" 2>/dev/null | grep -q "openapi.json"; then
        SHOULD_UPDATE=true
    fi
fi

if [ "$SHOULD_UPDATE" = true ]; then
    echo "Detected changes to api/openapi.json, updating OpenAPI clients..."
    
    cd "$REPO_ROOT/openapi-clients" || exit 1
    
    # Check if package.json exists
    if [ ! -f "package.json" ]; then
        echo "Error: package.json not found in openapi-clients directory"
        exit 1
    fi
    
    # Run the update-all-clients script
    npm run update-all-clients
    
    # Check if the command succeeded
    if [ $? -ne 0 ]; then
        echo "Error: npm run update-all-clients failed"
        exit 1
    fi
    
    echo "OpenAPI clients updated successfully"
    cd "$REPO_ROOT" || exit 1
fi

# Format and fix Rust code
cd "$REPO_ROOT/api" || exit 1

echo "Formatting and fixing Rust code..."

# Run cargo fmt
echo "Running cargo fmt..."
cargo fmt

# Check if cargo fmt succeeded
if [ $? -ne 0 ]; then
    echo "Error: cargo fmt failed"
    exit 1
fi

# Run cargo fix
echo "Running cargo fix..."
cargo fix --allow-staged

# Check if cargo fix succeeded
if [ $? -ne 0 ]; then
    echo "Error: cargo fix failed"
    exit 1
fi

# Check if cargo fix made any changes
if ! git diff --quiet; then
    echo ""
    echo "cargo fix made changes to your code."
    echo "Please review the changes, add them to staging, and commit again:"
    echo "  git add -A"
    echo "  git commit"
    exit 1
fi

echo "Pre-commit hook passed: Code formatted and fixed"
exit 0

