#!/bin/sh
# Pre-commit hook to format and fix Rust code
# This hook runs cargo fmt and cargo fix before committing
# If api/openapi.json has changed, it also updates all OpenAPI clients

cd "$(dirname "$0")/../.." || exit 1

cd openapi-clients || exit 1
echo "Running pre-commit hook..."
npm run update-all-clients
if [ $? -ne 0 ]; then
    echo "Error: npm run update-all-clients failed"
    exit 1
fi
git add openapi-clients
git commit -m "Update OpenAPI clients"

echo "OpenAPI clients updated successfully"
cd ../api || exit 1

echo "Formatting and fixing Rust code..."

# Run cargo fmt
echo "Running cargo fmt..."
cargo fmt

# Check if cargo fmt succeeded
if [ $? -ne 0 ]; then
    echo "Error: cargo fmt failed"
    exit 1
fi

# Run cargo fix
echo "Running cargo fix..."
cargo fix --allow-staged

# Check if cargo fix succeeded
if [ $? -ne 0 ]; then
    echo "Error: cargo fix failed"
    exit 1
fi

# Check if cargo fix made any changes
if ! git diff --quiet; then
    echo ""
    echo "cargo fix made changes to your code."
    echo "Please review the changes, add them to staging, and commit again:"
    echo "  git add -A"
    echo "  git commit"
    exit 1
fi

echo "Pre-commit hook passed: Code formatted and fixed"
exit 0

