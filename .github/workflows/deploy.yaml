# name: Build and Deploy API

# on:
#   push:
#     branches:
#       - master
#     paths:
#       - 'api/**'
#       - 'docker/**'

# env:
#   REGISTRY: ghcr.io
#   IMAGE_NAME: ${{ github.repository }}/api

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       packages: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Log in to Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ${{ env.REGISTRY }}
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}

#       - name: Extract metadata (tags, labels) for Docker
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
#           tags: |
#             type=ref,event=branch
#             type=sha,prefix={{branch}}-
#             type=raw,value=latest,enable={{is_default_branch}}

# docker buildx build \
#   --platform linux/amd64,linux/arm64 \
#   -t ghcr.io/emilsharkov/holy-bible-api/db-restore:latest \
#   --push \
#   --cache-to=type=inline \
#   .


#       - name: Build and push Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./api
#           file: api/Dockerfile
#           push: true
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max

#   deploy:
#     needs: build
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/master'

#     steps:
#       - name: Deploy to VPS
#         env:
#           SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
#           IMAGE_NAME: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
#         run: |
#           mkdir -p ~/.ssh
#           echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#           ssh-keyscan -H holy-bible-api.com >> ~/.ssh/known_hosts

#           ssh -i ~/.ssh/id_rsa root@holy-bible-api.com << 'EOF'
#             set -e

#             cd ~/holy-bible-api

#             echo "Pulling latest repo changes..."
#             git fetch origin
#             git reset --hard origin/master

#             cd docker

#             echo "Pulling latest images..."
#             docker compose pull

#             echo "Restarting services with new images..."
#             docker compose up -d --remove-orphans

#             echo "Cleaning up unused images..."
#             docker image prune -f

#             echo "Deploy complete."
#           EOF

#   publish-clients:
#     needs: build
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/master'
#     permissions:
#       contents: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}

#       - name: Set up Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20
#           registry-url: https://registry.npmjs.org

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Set up Rust
#         uses: dtolnay/rust-toolchain@stable

#       - name: Install OpenAPI Generator
#         run: |
#           npm install -g @openapitools/openapi-generator-cli
#           sudo ln -sf "$(which openapi-generator-cli)" /usr/local/bin/openapi-generator

#       - name: Generate clients from latest OpenAPI
#         working-directory: openapi-clients
#         run: npm run update-all-clients

#       - name: Bump client versions
#         working-directory: openapi-clients
#         run: python3 scripts/bump_versions.py

#       - name: Publish TypeScript client to npm
#         working-directory: openapi-clients/typescript/package
#         env:
#           NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
#         run: |
#           npm install
#           npm run push-package

#       - name: Publish Python client to PyPI
#         working-directory: openapi-clients/python/package
#         env:
#           TWINE_USERNAME: __token__
#           TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
#         run: |
#           python -m pip install --upgrade pip build twine
#           python -m build
#           twine upload dist/*

#       - name: Publish Rust client to crates.io
#         working-directory: openapi-clients/rust/package
#         env:
#           CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
#         run: cargo publish --allow-dirty

#       - name: Commit and push generated clients
#         run: |
#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"
#           git add openapi-clients
#           if [ -n "$(git status --porcelain)" ]; then
#             git commit -m "chore: update generated OpenAPI clients"
#             git push
#           else
#             echo "No changes to commit."
#           fi
